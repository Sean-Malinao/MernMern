"""Main FastAPI application for Mayombo AI Assistant"""

import random
from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel

from config import CORS_ORIGINS, APP_TITLE, APP_VERSION
from responses import RESPONSES
from nlp_utils import (
    detect_intent, detect_vibe, detect_language,
    apply_vibe_to_response, clean_response,
    add_conversational_flair, apply_conversational_logic
)
from candidate_manager import CandidateManager
from session_manager import SessionManager


# Initialize FastAPI app
app = FastAPI(title=APP_TITLE)

# Enable CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:5174",
        "http://127.0.0.1:5174"
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# === CONVERSATIONAL MEMORY (Simulates ML context awareness) ===
# In-memory session storage (lightweight - resets on server restart)
USER_SESSIONS = {}  # {user_ip: {"history": [msg1, msg2], "last_intent": "...", "last_position": "..."}}

def get_user_session(request: Request) -> dict:
    """Get or create session for user (identified by IP)"""
    user_ip = request.client.host
    if user_ip not in USER_SESSIONS:
        USER_SESSIONS[user_ip] = {"history": [], "last_intent": None, "last_position": None}
    return USER_SESSIONS[user_ip]

def update_session(session: dict, message: str, intent: str, position: str = None):
    """Update session with new message and context"""
    session["history"].append(message.lower())
    if len(session["history"]) > 3:  # Keep last 3 messages only
        session["history"].pop(0)
    session["last_intent"] = intent
    if position:
        session["last_position"] = position

# === VIBE DETECTION (English + Tagalog) ===
VIBE_KEYWORDS = {
    "english": {
        "positive": ["thank", "awesome", "nice", "cool", "love", "helpful", "smooth", "perfect", "great", "amazing", "thanks", "salamat"],
        "negative": ["don't get", "hard", "error", "why", "damn", "annoying", "broken", "frustrating", "help me", "can't find", "stupid", "worst", "nakakainis", "hirap", "galit"]
    },
    "tagalog": {
        "positive": ["salamat", "ganda", "galing", "aliw", "smooth", "perpekto", "magaling", "sarap", "saya", "thank you", "thanks"],
        "negative": ["hindi ko", "hirap", "error", "bakit", "puta", "bwiset", "sira", "nakakainis", "tulong", "di ko", "galit", "stress", "annoying", "frustrating"]
    }
}

def detect_vibe(message: str, language: str) -> str:
    """Lightweight vibe detection using keywords"""
    msg_lower = message.lower()
    lang_kw = VIBE_KEYWORDS.get(language, VIBE_KEYWORDS["english"])
    
    for kw in lang_kw["negative"]:
        if kw in msg_lower:
            return "negative"
    
    for kw in lang_kw["positive"]:
        if kw in msg_lower:
            return "positive"
    
    return "neutral"

def apply_vibe_to_response(reply: str, vibe: str, language: str) -> str:
    """Add vibe-appropriate touches WITHOUT changing factual content"""
    if vibe == "positive":
        closings = {
            "english": "\n\n‚ú® Happy to help! Your vote matters! üó≥Ô∏è",
            "tagalog": "\n\n‚ú® Masaya kaming makatulong! Mahalaga ang boto mo! üó≥Ô∏è"
        }
        return reply + closings.get(language, closings["english"])
    
    elif vibe == "negative":
        empathy = {
            "english": "üòî We understand this can be frustrating. ",
            "tagalog": "üòî Naiintindihan namin na nakakainis minsan. "
        }
        help_offer = {
            "english": "\n\nüìû Need help? Type 'help' for assistance!",
            "tagalog": "\n\nüìû Kailangan ng tulong? I-type ang 'help'!"
        }
        return empathy.get(language, empathy["english"]) + reply + help_offer.get(language, help_offer["english"])
    
    return reply

# === CONVERSATIONAL PHRASES (Simulates ML personality) ===
CONVERSATIONAL_STARTERS = {
    "english": [
        "Great question! ",
        "Ah, I see what you're asking. ",
        "Happy to help with that! ",
        "Let me explain clearly: ",
        "Good news: ",
        "Here's what you need to know: "
    ],
    "tagalog": [
        "Magandang tanong! ",
        "Naiintindihan ko ang itinatanong mo. ",
        "Masaya kong tutulungan ka! ",
        "Ipapaliwanag ko nang malinaw: ",
        "Magandang balita: ",
        "Eto ang kailangan mong malaman: "
    ]
}

FOLLOW_UP_SUGGESTIONS = {
    "kapitan_candidates": {
        "english": "\n\nüí° Want to know about SK Chairman candidates next?",
        "tagalog": "\n\nüí° Gusto mo bang malaman ang mga kandidato para sa SK Chairman susunod?"
    },
    "sk_candidates": {
        "english": "\n\nüí° Ready to learn the voting process?",
        "tagalog": "\n\nüí° Handa ka na bang matutunan ang proseso ng pagboto?"
    },
    "kagawad_candidates": {
        "english": "\n\nüí° Need help understanding how to vote for multiple Kagawads?",
        "tagalog": "\n\nüí° Kailangan mo ng tulong para maunawaan kung paano bumoto para sa maraming Kagawad?"
    },
    "eligibility": {
        "english": "\n\nüí° Would you like to know how to register next?",
        "tagalog": "\n\nüí° Gusto mo bang malaman kung paano magparehistro susunod?"
    },
    "voting_process": {
        "english": "\n\nüí° Want to see candidate lists before election day?",
        "tagalog": "\n\nüí° Gusto mo bang makita ang listahan ng mga kandidato bago ang araw ng halalan?"
    }
}

# === KNOWLEDGE BASE ===
CANDIDATES = {"Barangay Kapitan": [], "SK Chairman": [], "Kagawad": []}

# Load candidates from CSV
csv_path = os.path.join(os.path.dirname(__file__), "candidates.csv")

try:
    with open(csv_path, "r", encoding="utf-8") as f:
        reader = csv.DictReader(f)
        for row in reader:
            clean_row = {k.strip(): v.strip() for k, v in row.items()}
            position = clean_row.get("Position", "")
            name = clean_row.get("Candidate Name", "")
            party = clean_row.get("Party", "")

            if position == "Barangay Kapitan" and name:
                CANDIDATES["Barangay Kapitan"].append({"name": name, "party": party})
            elif position == "SK Chairman" and name:
                CANDIDATES["SK Chairman"].append({"name": name, "party": party})
            elif "kagawad" in position.lower() and name:
                CANDIDATES["Kagawad"].append({"name": name, "party": party})
    
    print(f"‚úÖ Loaded {len(CANDIDATES['Barangay Kapitan'])} Barangay Kapitan candidates")
    print(f"‚úÖ Loaded {len(CANDIDATES['SK Chairman'])} SK Chairman candidates")
    print(f"‚úÖ Loaded {len(CANDIDATES['Kagawad'])} Kagawad candidates (includes Barangay + SK)")

except Exception as e:
    print("‚ùå Error loading CSV:", e)
    import traceback
    traceback.print_exc()

# === INTENT PATTERNS (English & Tagalog) ===
INTENT_PATTERNS = [
    # Greetings (English & Tagalog) - ALL VARIATIONS
    (r'\b(hi|hello|hey|good (morning|afternoon|evening|day)|greetings|g\'day|yo|sup|what\'s up|wassup|hey there|hi there|howdy|how are you|kamusta|kumusta|magandang (umaga|tanghali|hapon|gabi)|kamusta ka|kumusta ka|musta|salamat|thank you|thanks|salamat po|salamat ka|hellooo|heyy|hey!|hi!|hello!|goodday|gday|greetings!|greetings,|hey there!|hi there!|howdy!|h3ll0|h3llo|h3l0|h3ll0|h3ll0|h3ll0|h3ll0|h3ll0|hiya|hey-hey|yo!|sup!|wassup!|what\'s up!|hola|bonjour|namaste|helloo|heyo|heyy|hey there|hi there|g\'day!|good day!|how are you?|kamusta ka?|kumusta ka?|musta?|salamat!|thank you!|thanks!|salamat po!|salamat ka!|h3ll0!|h3llo!|h3l0!|h3ll0!|h3ll0!|hiya!|hey-hey!|yo!|sup!|wassup!|what\'s up!|hola!|bonjour!|namaste!)\b', 'greeting', 1.0),
    
    # Candidates queries (English & Tagalog)
    (r'\b(barangay kapitan|captain|barangay captain|kapitan)\b', 'kapitan_candidates', 0.9),
    (r'\b(sino ang (mga )?kandidato|sino (mga )?tumatakbo|listahan ng kandidato)\b', 'all_candidates', 0.9),
    (r'\b(sk chairman|sk captain|sangguniang kabataan|sk chairperson)\b', 'sk_candidates', 0.9),
    (r'\b(kagawad|councilor|konsehal)\b', 'kagawad_candidates', 0.9),
    (r'\b(all candidates|show all|list all|lahat ng kandidato)\b', 'all_candidates', 0.8),
    (r'\b(sino|sinong|who are|who is)\b.*\b(kandidato|candidates|tumatakbo|running)\b', 'all_candidates', 0.8),
    
    # Voting process (English & Tagalog)
    (r'\b(how to vote|voting process|how do i vote|how can i vote|paano (ako )?bumoto|paano ang pagboto|proseso ng pagboto|voting steps|steps to vote|hakbang sa pagboto|cast vote|submit vote|iboto|magboto|kumpletuhin ang boto|confirm vote)\b', 'voting_process', 1.0),
    
    # Eligibility (English & Tagalog)
    (r'\b(eligible|can i vote|am i qualified|requirements|pwede ba ako bumoto|edad|age requirement|voter age|ilang taon|kwalipikado|qualified|karapat-dapat|kinakailangan|ano ang kailangan)\b', 'eligibility', 1.0),
    
    # Registration (English & Tagalog)
    (r'\b(register|registration|sign up|magparehistro|pagrehistro|paano (mag)?register|how to register|saan magparehistro|voter id|id ng botante|voter\'s id)\b', 'registration', 0.9),
    
    # Blockchain/Security (English & Tagalog)
    (r'\b(blockchain|secure|security|safe|ligtas|tamper|fraud|cheat|daya|pandaraya|protektado|protected|encrypted|secure ba|privacy|private|pribado|lihim)\b', 'security', 0.9),
    
    # Election info (English & Tagalog)
    (r'\b(when|date|schedule|election day|kailan|kailan ang halalan|petsa ng halalan|schedule ng eleksyon|where to vote|voting location|precinct|saan boboto|lugar ng pagboto|online|internet|sa bahay)\b.*\b(vote|boto)\b', 'election_date', 0.8),
    
    # Results/Counting (English & Tagalog) - NEUTRAL responses only
    (r'\b(results|tally|count|resulta|bilang|sino ang nanalo|who won|nag-lead|nangunguna|winning|prediction|who will win|forecast|manalo|real-time|live|realtime)\b', 'results_info', 0.9),
    
    # Voting rights & importance (English & Tagalog)
    (r'\b(why vote|bakit bumoto|importance|kahalagahan|karapatan|rights|right to vote)\b', 'importance', 1.0),
    
    # Problems/Issues (English & Tagalog)
    (r'\b(problema|problem|issue|error|hindi gumagana|not working|nakalimutan|forgot|password|voter id|nawala|lost|wala na)\b', 'technical_issue', 0.9),
    
    # Platform info (English & Tagalog)
    (r'\b(ano ang|what is|how does|paano gumagana)\b.*\b(system|platform|blockchain|features|functionality|gamit|magagawa)\b', 'platform_info', 0.9),
    
    # Positions explanation (English & Tagalog)
    (r'\b(ano ang|what is|tungkol sa)\b.*\b(kapitan|kagawad|sk chairman|role|tungkulin|responsibilidad|responsibility)\b', 'positions_info', 0.9),
    
    # Thank you (English & Tagalog)
    (r'\b(thank you|thanks|salamat|maraming salamat|thank u|ty)\b', 'thanks', 1.0),
    
    # Goodbye (English & Tagalog)
    (r'\b(bye|goodbye|exit|quit|paalam|sige na)\b', 'goodbye', 1.0),
    
    # Help (English & Tagalog)
    (r'\b(help|what can you do|commands|tulong|ano kaya mong gawin)\b', 'help', 1.0),
]

# === RESPONSE TEMPLATES (Bilingual + Conversational) ===
RESPONSES = {
    'greeting': [
        "‚ú® Hello there! I'm Mayombo's AI Election Assistant. I'm here to help with anything related to the upcoming barangay election.\n\nWhat would you like to know? You can ask about:\n‚Ä¢ Candidate information\n‚Ä¢ Voting process\n‚Ä¢ Eligibility requirements\n‚Ä¢ Election security\n\nJust type 'help' for a full list of what I can do! üòä",
        
        "üåü Hi! I'm your friendly neighborhood election assistant. Ready to help you navigate the Mayombo barangay election.\n\nHow can I assist you today? You can:\n‚Ä¢ Check candidate lists\n‚Ä¢ Learn how to vote\n‚Ä¢ Verify eligibility\n‚Ä¢ Understand security features\n\nAsk away! I'm here to help. üó≥Ô∏è",
        
        "üëã Hey! Mayombo Election Assistant here. I'm all set to help you with the barangay election.\n\nWhether you need candidate info, voting steps, or eligibility details‚ÄîI've got you covered!\n\nWhat would you like to know? Just ask! üí¨",
        
        "üòä Hello! I'm your go-to for all things Mayombo election. Need help with candidates, voting process, or anything else?\n\nI'm here to make your election experience smooth and stress-free. What would you like to know? üó≥Ô∏è",
        
        "üëã Hi there! Ready to dive into the Mayombo barangay election? I'm here to help with:\n‚Ä¢ Candidate information\n‚Ä¢ Voting procedures\n‚Ä¢ Eligibility requirements\n‚Ä¢ Security features\n\nJust ask me anything‚ÄîI'm all ears! üí¨"
    ],
    
    'voting_process': [
        "**Paano Bumoto sa Mayombo:**\n\n1Ô∏è‚É£ Mag-log in gamit ang iyong Voter ID at Petsa ng Kapanganakan\n2Ô∏è‚É£ I-verify ang iyong pagkakakilanlan\n3Ô∏è‚É£ Piliin ang iyong mga kandidato\n4Ô∏è‚É£ I-review ang iyong mga pinili\n5Ô∏è‚É£ I-confirm at i-submit ang boto\n\nüí° Tandaan: Isang beses lang ang pagboto at hindi na mababago pagkatapos i-submit!",
        "**How to Vote in Mayombo:**\n\n1Ô∏è‚É£ Log in with your Voter ID and Date of Birth\n2Ô∏è‚É£ Verify your identity\n3Ô∏è‚É£ Select your preferred candidates\n4Ô∏è‚É£ Review your choices\n5Ô∏è‚É£ Confirm and submit your vote\n\nüí° Remember: You can only vote once and cannot change after submission!",
    ],
    
    'eligibility': [
        "**Kinakailangan para Bumoto:**\n\n‚úÖ **Para sa SK Election:**\n‚Ä¢ Edad: 15-30 taong gulang\n‚Ä¢ Nakarehisto bilang SK voter sa Mayombo\n\n‚úÖ **Para sa Barangay Election:**\n‚Ä¢ Edad: 18 taong gulang pataas\n‚Ä¢ Nakarehisto bilang botante sa Mayombo\n‚Ä¢ Pilipinong mamamayan\n\nSiguraduhing nakarehisto ka na bago ang araw ng halalan!",
        "**Voter Eligibility Requirements:**\n\n‚úÖ **For SK Election:**\n‚Ä¢ Age: 15-30 years old\n‚Ä¢ Registered as SK voter in Mayombo\n\n‚úÖ **For Barangay Election:**\n‚Ä¢ Age: 18 years old and above\n‚Ä¢ Registered voter in Mayombo\n‚Ä¢ Filipino citizen\n\nMake sure you're registered before election day!",
    ],
    
    'registration': [
        "**Paano Magparehistro bilang Botante:**\n\nüìù **Mga Kakailanganin:**\n‚Ä¢ Valid ID (School ID, Birth Certificate, etc.)\n‚Ä¢ Proof of residency sa Mayombo\n‚Ä¢ Application form\n\nüìç **Saan magparehistro:**\nPunta sa Office of the Barangay sa Mayombo\n\n‚è∞ **Kailan:**\nTingnan ang opisyal na schedule ng COMELEC\n\nüí° **Para sa online registration**, maghintay ng announcement mula sa barangay!",
        "**How to Register as a Voter:**\n\nüìù **Requirements:**\n‚Ä¢ Valid ID (School ID, Birth Certificate, etc.)\n‚Ä¢ Proof of residency in Mayombo\n‚Ä¢ Application form\n\nüìç **Where to register:**\nVisit the Barangay Office in Mayombo\n\n‚è∞ **When:**\nCheck the official COMELEC schedule\n\nüí° **For online registration**, wait for official announcement from the barangay!",
    ],
    
    'security': [
        "**Seguridad ng Eleksyon:**\n\nüîí **Blockchain Technology**: Bawat boto ay naka-record sa blockchain ledger na hindi mababago\n\nüîê **Encryption**: Ang iyong boto ay naka-encrypt end-to-end\n\n‚úÖ **Verification**: Mave-verify ang bawat boto nang hindi nalalaman kung sino bumoto\n\nüö´ **Tamper-Proof**: Kapag nai-record na, hindi na mababago o matatanggal ang boto\n\nüõ°Ô∏è **Transparent**: Makikita ang bilang ng mga boto pero hindi ang identity ng bumoto\n\nLigtas at secure ang iyong boto!",
        "**Election Security Features:**\n\nüîí **Blockchain Technology**: Every vote is recorded on an immutable blockchain ledger\n\nüîê **Encryption**: Your vote is encrypted end-to-end\n\n‚úÖ **Verification**: Each vote can be verified without revealing voter identity\n\nüö´ **Tamper-Proof**: Once recorded, votes cannot be altered or deleted\n\nüõ°Ô∏è **Transparent**: Vote counts are visible but voter identity remains private\n\nYour vote is safe and secure!",
    ],
    
    'privacy': [
        "**Privacy at Confidentiality:**\n\nüîí Ang iyong boto ay **100% lihim**\n\n‚úÖ Walang makakakita kung sino ang binoto mo\n\nüõ°Ô∏è Ang sistema ay hindi nag-store ng koneksyon sa pagitan ng voter at kandidato\n\nüìä Makikita lang ang kabuuang bilang ng boto, hindi individual votes\n\nAng iyong privacy ay protektado!",
    ],
    
    'election_date': [
        "**Petsa ng Halalan:**\n\nüìÖ Ang Mayombo Barangay Election ay susundin ang schedule ng COMELEC.\n\nüïí Para sa eksaktong petsa at oras, mangyaring magtanong sa inyong local election office.\n\nüì¢ Abangan ang opisyal na pag-announce!\n\nüí° **Tip**: I-save ang petsa sa iyong calendar para hindi makalimutan!",
        "**Election Schedule:**\n\nüìÖ The Mayombo Barangay Election follows the COMELEC schedule.\n\nüïí For the exact date and time, please check with your local election office.\n\nüì¢ Stay tuned for official announcements!\n\nüí° **Tip**: Save the date on your calendar so you won't forget!",
    ],
    
    'voting_location': [
        "**Saan Boboto:**\n\nüíª **Online Voting**: Pwede kang bumoto online through this secure platform kahit saan ka naroroon basta may internet!\n\nüè¢ **In-Person** (kung available): Tingnan ang iyong voter registration para sa assigned precinct mo sa Barangay Mayombo.\n\nüì± Mas convenient ang online voting - boto ka kahit nasa bahay!",
        "**Where to Vote:**\n\nüíª **Online Voting**: You can vote online through this secure platform from anywhere with internet access!\n\nüè¢ **In-Person** (if available): Check your voter registration for your assigned precinct in Barangay Mayombo.\n\nüì± Online voting is more convenient - vote from the comfort of your home!",
    ],
    
    'online_voting': [
        "**Online Voting:**\n\n‚úÖ **Pwede ka bumoto online!**\n\nüì± Mga device na pwede gamitin:\n‚Ä¢ Computer/Laptop\n‚Ä¢ Tablet\n‚Ä¢ Smartphone\n\nüåê Kailangan lang ng stable internet connection\n\nüîí Ligtas at secure ang online voting dahil sa blockchain technology\n\nüí° Vote kahit saan ka - sa bahay, opisina, o kahit nasaan!",
    ],
    
    'results_info': [  # NEUTRAL - no predictions/counts
        "üó≥Ô∏è **Tungkol sa Resulta ng Halalan:**\n\nAng opisyal na resulta ay ipapahayag pagkatapos ng voting period ayon sa schedule ng COMELEC.\n\nüîç Ang sistema ay transparent at verifiable - maaari mong i-verify ang proseso ng pagbilang.\n\nüí° Para sa opisyal na resulta, mangyaring maghintay ng announcement mula sa inyong Barangay Captain at COMELEC.",
        "üó≥Ô∏è **About Election Results:**\n\nOfficial results will be announced after the voting period closes, following COMELEC schedule.\n\nüîç The system is transparent and verifiable - you can verify the counting process.\n\nüí° For official results, please wait for announcements from your Barangay Captain and COMELEC.",
    ],
    
    'importance': [
        "**Bakit Mahalaga ang Pagboto:**\n\nüó≥Ô∏è **Karapatan mo ito** - Ito ay constitutional right ng bawat mamamayan\n\nüèòÔ∏è **Makakaapekto sa barangay** - Ang mga napipili mo ay maglilingkod sa inyong komunidad\n\nüí™ **Iyong tinig** - Ang boto mo ay ang paraan para marinig ka\n\nüë• **Accountability** - Pipiliin mo ang mga responsableng lider\n\nüåü **Pagbabago** - Nagsisimula sa local governance ang tunay na pagbabago\n\nAng iyong boto ay may kapangyarihan!",
    ],
    
    'voting_rights': [
        "**Karapatan sa Pagboto:**\n\n‚úÖ Bawat qualified citizen ay may karapatang bumoto\n‚úÖ Walang pwedeng pumigil sa iyo na bumoto\n‚úÖ Ang iyong boto ay lihim at protektado\n‚úÖ Hindi ka pwedeng pilitin kung sino iboboto\n‚úÖ Pantay-pantay ang lahat ng boto\n\nüõ°Ô∏è Ang mga karapatan mo ay protektado ng Konstitusyon at batas!",
    ],
    
    'technical_issue': [
        "**May Problema sa Sistema?**\n\nüîß Subukan ang mga sumusunod:\n\n1Ô∏è‚É£ I-refresh ang page (F5)\n2Ô∏è‚É£ I-clear ang browser cache\n3Ô∏è‚É£ Gumamit ng updated browser\n4Ô∏è‚É£ I-check ang internet connection\n\nüìû **Kung patuloy ang problema:**\nMakipag-ugnayan sa technical support:\n‚Ä¢ Email: support@mayombo-voting.ph\n‚Ä¢ Hotline: (Available during election period)\n\nüí° Mag-screenshot ng error para mas mabilis masolusyunan!",
    ],
    
    'forgot_credentials': [
        "**Nakalimutan ang Voter ID o Password?**\n\nüîë **Para sa Voter ID:**\n‚Ä¢ Tingnan ang iyong voter registration certificate\n‚Ä¢ Contact ang Barangay Office\n‚Ä¢ Dalhin ang valid ID para ma-verify\n\nüîê **Para sa Password:**\n‚Ä¢ I-click ang 'Forgot Password' sa login page\n‚Ä¢ Susundin ang instructions na ipapadala sa registered email/phone\n\nüìû **Kailangan ng tulong:**\nPumunta sa Barangay Office na may dalang valid ID\n\nüí° I-save ang credentials mo sa safe place!",
    ],
    
    'platform_info': [
        "**Tungkol sa Mayombo Voting Platform:**\n\nüåê Ito ay secure, blockchain-based voting system\n\n‚ú® **Features:**\n‚Ä¢ End-to-end encryption\n‚Ä¢ Real-time vote counting\n‚Ä¢ Tamper-proof records\n‚Ä¢ Anonymous voting\n‚Ä¢ Accessible kahit saan\n\nüîí Gumagamit ng latest technology para sa:\n‚Ä¢ Security\n‚Ä¢ Transparency\n‚Ä¢ Convenience\n‚Ä¢ Accuracy\n\nModernong paraan ng pagboto para sa Mayombo!",
    ],
    
    'features': [
        "**Ano ang Magagawa ng Platform:**\n\n‚úÖ Tingnan ang mga kandidato\n‚úÖ Bumoto ng secure at private\n‚úÖ I-verify ang iyong boto\n‚úÖ Makita ang real-time results\n‚úÖ View election statistics\n‚úÖ Makatanggap ng notifications\n‚úÖ Access voter education materials\n\nüì± User-friendly interface\nüîí Maximum security\n‚ö° Fast at efficient\n\nLahat ng kailangan mo para sa democratic participation!",
    ],
    
    'positions_info': [
        "**Mga Posisyon sa Barangay Election:**\n\nüëî **Barangay Kapitan**\n‚Ä¢ Pinuno ng barangay\n‚Ä¢ Namamahala sa day-to-day operations\n‚Ä¢ Nag-implement ng programs at policies\n\nüë• **Barangay Kagawad** (Councilors)\n‚Ä¢ Miyembro ng Sangguniang Barangay\n‚Ä¢ Tumutulong sa pagpapasa ng ordinansa\n‚Ä¢ May specific committees\n\nüéì **SK Chairman**\n‚Ä¢ Pinuno ng Sangguniang Kabataan\n‚Ä¢ Nag-represent sa kabataan (15-30 years old)\n‚Ä¢ Nag-organize ng youth programs\n\nLahat ay may mahalagang papel sa barangay!",
    ],
    
    'thanks': [
        "Walang anuman! üòä\n\nMay iba ka pang tanong? Nandito lang ako para tumulong!\n\nüó≥Ô∏è Huwag kalimutang bumoto!",
        "You're welcome! üòä\n\nDo you have any other questions? I'm here to help!\n\nüó≥Ô∏è Don't forget to vote!",
        "Salamat sa pagtanong! May matutulungan pa ba ako?",
    ],
    
    'goodbye': [
        "Paalam! Salamat sa pagbisita. üëã\n\nüó≥Ô∏è Tandaan: Ang iyong boto ay mahalaga!\n\nHanggang sa muli!",
        "Goodbye! Thanks for visiting. üëã\n\nüó≥Ô∏è Remember: Your vote matters!\n\nSee you again!",
        "Sige, ingat! Bumoto ka ha! üó≥Ô∏èüòä",
    ],
    
    'help': [
        "**Matutulungan kita sa mga sumusunod:**\n\nüìã **Kandidato**\n‚Ä¢ Sino ang tumatakbo?\n‚Ä¢ Partido ng kandidato\n‚Ä¢ Lahat ng kandidato\n\nüó≥Ô∏è **Pagboto**\n‚Ä¢ Paano bumoto?\n‚Ä¢ Saan boboto?\n‚Ä¢ Kailan ang halalan?\n\n‚úÖ **Eligibility**\n‚Ä¢ Pwede ba ako bumoto?\n‚Ä¢ Ano ang requirements?\n\nüîí **Seguridad**\n‚Ä¢ Gaano ka-secure?\n‚Ä¢ Ano ang blockchain?\n\nüí° **Subukan:**\n‚Ä¢ \"Sino ang kandidato para sa kapitan?\"\n‚Ä¢ \"Paano ako boboto?\"\n‚Ä¢ \"Pwede ba akong bumoto?\"\n‚Ä¢ \"Gaano kasecure ang election?\"\n‚Ä¢ \"Kailan ang halalan?\"\n\nType 'help' anytime kung kailangan mo ng tulong!",
        "**I can help you with:**\n\nüìã **Candidates**\n‚Ä¢ Who are running?\n‚Ä¢ Candidate's party\n‚Ä¢ All candidates\n\nüó≥Ô∏è **Voting**\n‚Ä¢ How to vote?\n‚Ä¢ Where to vote?\n‚Ä¢ When is the election?\n\n‚úÖ **Eligibility**\n‚Ä¢ Can I vote?\n‚Ä¢ What are the requirements?\n\nüîí **Security**\n‚Ä¢ How secure is it?\n‚Ä¢ What is blockchain?\n\nüí° **Try asking:**\n‚Ä¢ \"Who are the barangay kapitan candidates?\"\n‚Ä¢ \"How do I vote?\"\n‚Ä¢ \"Am I eligible to vote?\"\n‚Ä¢ \"How secure is this election?\"\n‚Ä¢ \"When is the election?\"\n\nType 'help' anytime you need assistance!",
    ],
    
    'unknown': [
        "Hindi ko masyadong naintindihan ang iyong tanong. ü§î\n\nPwede mo bang ulitin o gawing mas malinaw?\n\nüí° **Pwede mong itanong ang tungkol sa:**\n‚Ä¢ Kandidato\n‚Ä¢ Proseso ng pagboto\n‚Ä¢ Kinakailangan para bumoto\n‚Ä¢ Seguridad ng eleksyon\n\nI-type ang 'help' para makita ang buong listahan!",
        "I'm not sure I understood that. ü§î\n\nCould you rephrase your question?\n\nüí° **You can ask me about:**\n‚Ä¢ Candidates\n‚Ä¢ Voting process\n‚Ä¢ Eligibility\n‚Ä¢ Election security\n\nType 'help' to see what I can do!",
        "Pasensya na, hindi ko naintindihan. Pwede bang mas specific? Type 'help' para sa mga sample questions! üòä",
    ]
}

class ChatMessage(BaseModel):
    message: str

def detect_intent(message: str) -> Tuple[str, float]:
    """Detect user intent using pattern matching"""
    message = message.lower().strip()
    
    best_intent = 'unknown'
    best_score = 0.0
    
    for pattern, intent, base_score in INTENT_PATTERNS:
        if re.search(pattern, message, re.IGNORECASE):
            if base_score > best_score:
                best_score = base_score
                best_intent = intent
    
    return best_intent, best_score

def format_candidates(position: str) -> str:
    """Format candidate list for display"""
    if not CANDIDATES.get(position):
        return f"Walang nahanap na kandidato para sa {position} sa database."
    
    tagalog_positions = {
        "Barangay Kapitan": "Barangay Kapitan",
        "SK Chairman": "SK Chairman",
        "Kagawad": "Kagawad"
    }
    
    candidates_list = [f"‚Ä¢ {c['name']} ({c['party']})" for c in CANDIDATES[position]]
    
    header = f"**Mga Kandidato para sa {tagalog_positions.get(position, position)}:**\n\n"
    candidates_text = "\n".join(candidates_list)
    footer = f"\n\nüìä Kabuuang kandidato: {len(CANDIDATES[position])}"
    
    return header + candidates_text + footer

def get_candidate_info(message: str) -> str:
    """Extract specific candidate name from message"""
    message_lower = message.lower()
    
    for position, candidates in CANDIDATES.items():
        for candidate in candidates:
            if candidate['name'].lower() in message_lower:
                return f"**{candidate['name']}**\n\nPosisyon: {position}\nPartido: {candidate['party']}\n\nüéØ Good luck sa lahat ng mga kandidato!\n\nMay iba ka pang gustong malaman tungkol sa kandidatong ito?"
    
    return None

def detect_language(message: str) -> str:
    """Improved language detection (English vs Tagalog)"""
    msg_lower = message.lower().strip()
    
    # Strong English indicators (prioritize these)
    english_indicators = ['thank', 'thanks', 'you ', 'your ', 'how to', 'can i', 'what is', 'where ', 'when ', 'who ', 'vote', 'candidates', 'eligible', 'register']
    english_score = sum(1 for word in english_indicators if word in msg_lower)
    
    # Strong Tagalog indicators
    tagalog_indicators = ['ang ', 'ng ', 'sa ', 'mga ', 'ko ', 'mo ', 'ano ', 'sino ', 'paano ', 'salamat', 'boto', 'kandidato', 'bumoto', 'pagboto']
    tagalog_score = sum(1 for word in tagalog_indicators if word in msg_lower)
    
    # Decision logic
    if english_score > tagalog_score:
        return 'english'
    elif tagalog_score > 0:
        return 'tagalog'
    else:
        # Default to English for neutral/ambiguous messages
        return 'english'

def clean_response(intent: str, text: str) -> str:
    """Remove headers that repeat the user's question"""
    INTENT_HEADERS = {
        "voting_process": ["paano bumoto", "how to vote", "voting process", "hakbang sa pagboto"],
        "eligibility": ["kinakailangan para bumoto", "voter eligibility"],
        "registration": ["paano magparehistro", "how to register"]
    }

    if intent in INTENT_HEADERS:
        for header in INTENT_HEADERS[intent]:
            text = re.sub(rf"\*\*.*{header}.*?\*\*\s*", "", text, flags=re.IGNORECASE)
            text = re.sub(rf".*{header}.*:\s*", "", text, flags=re.IGNORECASE)

    return text.strip()

def add_conversational_flair(reply: str, intent: str, language: str) -> str:
    """Add natural conversation flow (simulates ML personality)"""
    # Add starter phrase for non-greeting intents
    if intent not in ['greeting', 'thanks', 'goodbye', 'unknown']:
        starter = random.choice(CONVERSATIONAL_STARTERS.get(language, CONVERSATIONAL_STARTERS["english"]))
        reply = starter + reply
    
    # Add follow-up suggestion for key intents
    if intent in FOLLOW_UP_SUGGESTIONS:
        suggestion = FOLLOW_UP_SUGGESTIONS[intent].get(language, FOLLOW_UP_SUGGESTIONS[intent]["english"])
        reply += suggestion
    
    # Special handling for greetings
    elif intent == 'greeting':
        # Add a warm, human-like closing to greetings
        closing = random.choice([
            "\n\nWhat would you like to know about the election?",
            "\n\nHow can I help you today?",
            "\n\nAsk me anything about the Mayombo election!",
            "\n\nReady to make your voice heard? üí¨",
            "\n\nI'm here to help with anything election-related!"
        ])
        reply += closing
    
    return reply

def apply_conversational_logic(user_msg: str, intent: str, lang: str, session: dict) -> str:
    """Handle conversational follow-ups and context"""
    if intent == 'unknown':
        last_intent = session.get("last_intent")
        last_position = session.get("last_position")
        
        # Handle "and for SK?" type follow-ups
        if last_intent in ['kapitan_candidates', 'kagawad_candidates'] and re.search(r'\b(sk|sangguniang kabataan)\b', user_msg, re.IGNORECASE):
            return 'sk_candidates'
        elif last_intent == 'sk_candidates' and re.search(r'\b(kapitan|barangay captain)\b', user_msg, re.IGNORECASE):
            return 'kapitan_candidates'
        elif last_intent in ['kapitan_candidates', 'sk_candidates'] and re.search(r'\b(kagawad|councilor)\b', user_msg, re.IGNORECASE):
            return 'kagawad_candidates'
    
    return intent

@app.post("/chat")
async def chat(msg: ChatMessage, request: Request):
    user_msg = msg.message.strip()
    
    if not user_msg:
        return {"reply": "Walang mensahe. Ano ang gusto mong itanong? üòä"}
    
    # Get user session for context awareness
    session = get_user_session(request)
    
    # Detect intent and language
    intent, confidence = detect_intent(user_msg)
    lang = detect_language(user_msg)
    vibe = detect_vibe(user_msg, lang)
    
    # Apply conversational context logic
    intent = apply_conversational_logic(user_msg, intent, lang, session)
    
    # Handle candidate-specific queries
    if intent == 'kapitan_candidates':
        reply = format_candidates("Barangay Kapitan")
        reply = add_conversational_flair(reply, intent, lang)
        reply = apply_vibe_to_response(reply, vibe, lang)
        update_session(session, user_msg, intent, "Barangay Kapitan")
        return {"reply": reply}
    
    elif intent == 'sk_candidates':
        reply = format_candidates("SK Chairman")
        reply = add_conversational_flair(reply, intent, lang)
        reply = apply_vibe_to_response(reply, vibe, lang)
        update_session(session, user_msg, intent, "SK Chairman")
        return {"reply": reply}
    
    elif intent == 'kagawad_candidates':
        reply = format_candidates("Kagawad")
        reply = add_conversational_flair(reply, intent, lang)
        reply = apply_vibe_to_response(reply, vibe, lang)
        update_session(session, user_msg, intent, "Kagawad")
        return {"reply": reply}
    
    elif intent == 'all_candidates':
        reply = "**Lahat ng Kandidato / All Candidates:**\n\n"
        for position in ["Barangay Kapitan", "SK Chairman", "Kagawad"]:
            reply += format_candidates(position) + "\n\n"
        reply += "üó≥Ô∏è Piliin nang mabuti! Choose wisely!"
        reply = add_conversational_flair(reply, intent, lang)
        reply = apply_vibe_to_response(reply, vibe, lang)
        update_session(session, user_msg, intent)
        return {"reply": reply.strip()}
    
    # Check if asking about specific candidate
    candidate_info = get_candidate_info(user_msg)
    if candidate_info:
        reply = candidate_info
        reply = add_conversational_flair(reply, 'candidate_detail', lang)
        reply = apply_vibe_to_response(reply, vibe, lang)
        update_session(session, user_msg, 'candidate_detail')
        return {"reply": reply}
    
    # Handle general intents (voting_process, eligibility, etc.)
    if intent in RESPONSES:
        responses = RESPONSES[intent]
        
        # Filter responses by detected language
        if lang == 'tagalog':
            # Prefer responses with Tagalog markers
            filtered = [r for r in responses if any(word in r.lower() for word in ['ang ', 'mga ', ' sa ', ' ng ', 'boto', 'kandidato', 'pagboto', 'botante'])]
        else:  # english
            # Prefer responses WITHOUT strong Tagalog markers
            filtered = [r for r in responses if not any(marker in r.lower() for marker in [' ang ', ' mga ', ' sa ', ' ng '])]
        
        # Use filtered responses if available, else fallback
        reply = random.choice(filtered) if filtered else random.choice(responses)
        
        reply = clean_response(intent, reply)
        reply = add_conversational_flair(reply, intent, lang)
        reply = apply_vibe_to_response(reply, vibe, lang)
        update_session(session, user_msg, intent)
        return {"reply": reply}
    
    # Default unknown response
    unknown_responses = RESPONSES['unknown']
    # Prefer Tagalog for unknown if user used Tagalog
    if lang == 'tagalog':
        reply = unknown_responses[0]
    else:
        reply = random.choice(unknown_responses)
    
    reply = clean_response('unknown', reply)
    reply = add_conversational_flair(reply, 'unknown', lang)
    reply = apply_vibe_to_response(reply, vibe, lang)
    update_session(session, user_msg, 'unknown')
    return {"reply": reply}

@app.get("/")
async def root():
    return {
        "message": "Mayombo AI Assistant is running! / Gumagana ang Mayombo AI Assistant!",
        "status": "online",
        "version": "4.0 - Conversational Edition"
    }

@app.get("/health")
async def health():
    return {
        "status": "healthy",
        "candidates_loaded": sum(len(v) for v in CANDIDATES.values()),
        "total_kapitan": len(CANDIDATES["Barangay Kapitan"]),
        "total_sk": len(CANDIDATES["SK Chairman"]),
        "total_kagawad": len(CANDIDATES["Kagawad"]),
        "language_support": ["English", "Tagalog"],
        "vibe_detection": "enabled",
        "conversational_ai": "enabled"
    }

@app.get("/stats")
async def stats():
    """Get chatbot statistics"""
    return {
        "total_intents": len(set(intent for _, intent, _ in INTENT_PATTERNS)),
        "total_patterns": len(INTENT_PATTERNS),
        "supported_languages": ["English", "Tagalog"],
        "total_candidates": sum(len(v) for v in CANDIDATES.values()),
        "positions": list(CANDIDATES.keys()),
        "vibe_aware": True,
        "context_aware": True
    }